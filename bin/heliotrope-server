#!/usr/bin/env ruby

require 'rubygems'
require 'json'
require 'trollop'
require 'sinatra/base'
require 'whistlepig'
require "heliotrope"

$opts = Trollop::options do
  banner <<EOS
Usage: #{$0} [options]

Where options include:
EOS
  opt :host, "Host interface to listen on", :default => "0.0.0.0", :short => "-H"
  opt :port, "Port to listen on", :default => 8042
  opt :dir, "Base directory for all index files", :default => "."
end

$store = Heliotrope::Store.new $opts.dir
$mbox = File.open(File.join($opts.dir, "mbox"), "a+")

class HeliotropeServer < Sinatra::Base
  set :host, $opts.host
  set :port, $opts.port

  get "/" do
    content_type :html
    <<EOS
<p>
  Welcome to Heliotrope. This is the simplest possible HTML view of your email.
  To get started, I suggest you start <a href="/search?q=~inbox">at your inbox</a>.
</p>
EOS
  end

  get "/search" do
    content_type :html
    begin
      q = Heliotrope::Query.new "body", params["q"]
      $store.set_query q
      results = $store.get_some_results 10
      "<pre>" + results.inspect + "</pre>"
    rescue Whistlepig::ParseError => e
      "<pre>" + e.message + "</pre>"
    end
  end
end

HeliotropeServer.run!
